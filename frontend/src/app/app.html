<!-- Si NO estÃ¡ logueado: solo mostrar el router (login page) -->
<div *ngIf="!auth.isLoggedIn">
  <router-outlet></router-outlet>
</div>

<!-- Si ESTÃ logueado: mostrar sidebar + contenido -->
<div class="app-container" *ngIf="auth.isLoggedIn">

  <!-- Sidebar Lateral -->
  <aside class="sidebar" [class.active]="menuOpen">
    <div class="sidebar-brand">
      <span>Micromercado</span>
    </div>

    <nav class="sidebar-nav">
      <a routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" class="nav-item"
        (click)="menuOpen = false">
        ğŸ“Š Dashboard
      </a>

      <a routerLink="/productos" routerLinkActive="active" class="nav-item" *ngIf="auth.tieneAcceso('productos')"
        (click)="menuOpen = false">
        ğŸ“¦ Productos
      </a>

      <a routerLink="/categorias" routerLinkActive="active" class="nav-item" *ngIf="auth.tieneAcceso('categorias')"
        (click)="menuOpen = false">
        ğŸ·ï¸ CategorÃ­as
      </a>

      <a routerLink="/ventas" routerLinkActive="active" class="nav-item" *ngIf="auth.tieneAcceso('ventas')"
        (click)="menuOpen = false">
        ğŸ§¾ Ventas
      </a>

      <a routerLink="/compras" routerLinkActive="active" class="nav-item" *ngIf="auth.tieneAcceso('compras')"
        (click)="menuOpen = false">
        ğŸ›ï¸ Compras
      </a>

      <a routerLink="/clientes" routerLinkActive="active" class="nav-item" *ngIf="auth.tieneAcceso('clientes')"
        (click)="menuOpen = false">
        ğŸ§‘â€ğŸ’¼ Clientes
      </a>

      <a routerLink="/movimientos" routerLinkActive="active" class="nav-item" *ngIf="auth.tieneAcceso('movimientos')"
        (click)="menuOpen = false">
        ğŸ“‹ Movimientos
      </a>

      <a routerLink="/proveedores" routerLinkActive="active" class="nav-item" *ngIf="auth.tieneAcceso('proveedores')"
        (click)="menuOpen = false">
        ğŸšš Proveedores
      </a>

      <a routerLink="/descuentos" routerLinkActive="active" class="nav-item" *ngIf="auth.tieneAcceso('descuentos')"
        (click)="menuOpen = false">
        ğŸ·ï¸ Descuentos
      </a>

      <a routerLink="/reportes" routerLinkActive="active" class="nav-item" *ngIf="auth.tieneAcceso('reportes')"
        (click)="menuOpen = false">
        ğŸ“ˆ Reportes
      </a>

      <a routerLink="/usuarios" routerLinkActive="active" class="nav-item" *ngIf="auth.tieneAcceso('usuarios')"
        (click)="menuOpen = false">
        ğŸ‘¥ Usuarios
      </a>

      <!-- Solo para administradores -->
      <div class="nav-separator" *ngIf="auth.tieneAcceso('configuracion')">Sistema</div>

      <a routerLink="/configuracion" routerLinkActive="active" class="nav-item"
        *ngIf="auth.tieneAcceso('configuracion')" (click)="menuOpen = false">
        âš™ï¸ ConfiguraciÃ³n
      </a>

      <a routerLink="/auditoria" routerLinkActive="active" class="nav-item" *ngIf="auth.tieneAcceso('auditoria')"
        (click)="menuOpen = false">
        ğŸ“ AuditorÃ­a
      </a>
    </nav>

    <div class="sidebar-footer">
      <div class="user-profile-mini">
        <div class="role-badge" [ngClass]="{
                    'role-admin': auth.rolNombre === 'Administrador',
                    'role-cajero': auth.rolNombre === 'Cajero',
                    'role-bodeguero': auth.rolNombre === 'Bodeguero'
                }">
          {{ auth.rolNombre }}
        </div>
      </div>
      <p>Micromercado MuÃ±oz</p>
    </div>
  </aside>

  <!-- Contenido Principal -->
  <div class="main-wrapper">

    <!-- Top Header -->
    <header class="top-header">
      <button class="header-toggle" (click)="toggleMenu()">â˜°</button>

      <!-- Search Bar -->
      <div class="search-wrapper">
        <div class="search-bar">
          <span class="search-icon">ğŸ”</span>
          <input type="text" placeholder="Buscar productos, clientes, ventas..." [(ngModel)]="searchQuery"
            (input)="buscar()" (focus)="searchOpen = true">
        </div>
        <div class="search-dropdown" *ngIf="searchOpen && searchQuery.trim()">
          <div *ngIf="searchLoading" class="search-loading">Buscando...</div>

          <div *ngIf="searchResults.productos?.length > 0" class="search-group">
            <div class="search-group-title">ğŸ“¦ Productos</div>
            <div *ngFor="let p of searchResults.productos" class="search-item" (click)="irA('producto', p.prodid)">
              <span>{{ p.prodnombre }}</span>
              <small>{{ p.prodcodigo }}</small>
            </div>
          </div>

          <div *ngIf="searchResults.clientes?.length > 0" class="search-group">
            <div class="search-group-title">ğŸ§‘â€ğŸ’¼ Clientes</div>
            <div *ngFor="let c of searchResults.clientes" class="search-item" (click)="irA('cliente', c.cliid)">
              <span>{{ c.clinombre }}</span>
              <small>{{ c.clicidruc }}</small>
            </div>
          </div>

          <div *ngIf="searchResults.ventas?.length > 0" class="search-group">
            <div class="search-group-title">ğŸ§¾ Ventas</div>
            <div *ngFor="let v of searchResults.ventas" class="search-item" (click)="irA('venta', v.venid)">
              <span>{{ v.vennumero }}</span>
              <small>${{ v.ventotal }}</small>
            </div>
          </div>

          <div
            *ngIf="!searchLoading && searchResults.productos?.length === 0 && searchResults.clientes?.length === 0 && searchResults.ventas?.length === 0"
            class="search-empty">
            Sin resultados para "{{ searchQuery }}"
          </div>
        </div>
      </div>

      <div class="header-user">
        <!-- Dark Mode Toggle -->
        <button class="theme-btn" (click)="toggleDarkMode()" [title]="darkMode ? 'Modo Claro' : 'Modo Oscuro'">
          {{ darkMode ? 'Modo claro' : 'Modo oscuro' }}
        </button>

        <!-- Notificaciones -->
        <div class="notif-wrapper">
          <button class="notif-btn" (click)="toggleNotif()" title="Notificaciones">
            ğŸ””
            <span class="notif-badge" *ngIf="notificaciones.length > 0">{{ notificaciones.length }}</span>
          </button>
          <div class="notif-dropdown" *ngIf="notifOpen">
            <div class="notif-header">
              <strong>âš ï¸ Alertas de Stock</strong>
            </div>
            <div *ngIf="notificaciones.length === 0" class="notif-empty">
              Sin alertas
            </div>
            <div class="notif-list">
              <div *ngFor="let n of notificaciones.slice(0, 8)" class="notif-item">
                <span class="notif-product">{{ n.prodnombre || n.nombre }}</span>
                <span class="notif-stock badge badge-danger">{{ n.prodstock_global || n.stock_actual }} un.</span>
              </div>
            </div>
          </div>
        </div>

        <div class="user-info text-right">
          <span class="user-name">{{ auth.usuario?.usuusuario }}</span>
          <span class="user-role">{{ auth.rolNombre }}</span>
        </div>
        <div class="user-avatar" [ngClass]="{
                    'avatar-admin': auth.rolNombre === 'Administrador',
                    'avatar-cajero': auth.rolNombre === 'Cajero',
                    'avatar-bodeguero': auth.rolNombre === 'Bodeguero'
                }">{{ getIniciales() }}</div>
        <button class="btn-logout" (click)="logout()" title="Cerrar SesiÃ³n">
          Cerrar sesiÃ³n
        </button>
      </div>
    </header>

    <!-- Router Outlet -->
    <main class="page-content">
      <router-outlet></router-outlet>
    </main>

  </div>

</div>