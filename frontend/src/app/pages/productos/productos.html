<div class="page-productos">
    <header class="page-header">
        <h1>Productos</h1>
        <button class="btn btn-primary" (click)="abrirModal()">+ Nuevo Producto</button>
    </header>

    <!-- Barra de búsqueda -->
    <div class="search-bar">
        <input type="text" class="form-control" placeholder="Buscar por nombre o código..." [(ngModel)]="filtro"
            (keyup.enter)="buscar()">
        <button class="btn btn-secondary" (click)="buscar()">Buscar</button>
    </div>

    <!-- Tabla de productos -->
    <div class="card">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Nombre</th>
                        <th>Categoría</th>
                        <th>P. Venta</th>
                        <th>IVA</th>
                        <th>Stock</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let p of productosFiltrados" [class.stock-bajo]="p.prodstock_global <= p.prodminimo">
                        <td>{{ p.prodcodigo }}</td>
                        <td>
                            <strong>{{ p.prodnombre }}</strong>
                            <small class="text-muted d-block">{{ p.proddescripcion }}</small>
                        </td>
                        <td>{{ p.categoria_nombre || '-' }}</td>
                        <td>$ {{ p.prodprecio_venta | number:'1.2-2' }}</td>
                        <td>
                            <span class="badge" [ngClass]="p.prodtiene_iva ? 'badge-info' : 'badge-secondary'">
                                {{ p.prodtiene_iva ? 'Sí' : 'No' }}
                            </span>
                        </td>
                        <td>
                            <span class="badge"
                                [ngClass]="p.prodstock_global <= p.prodminimo ? 'badge-danger' : 'badge-success'">
                                {{ p.prodstock_global }}
                            </span>
                        </td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-sm btn-secondary" (click)="abrirModal(p)">Editar</button>
                                <button class="btn btn-sm btn-info" (click)="abrirModalProveedores(p)"
                                    title="Proveedores">Proveedores</button>
                                <button class="btn btn-sm btn-warning" (click)="abrirKardex(p)"
                                    title="Kardex">Kardex</button>
                                <button class="btn btn-sm btn-danger" (click)="eliminar(p)">X</button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div *ngIf="productosFiltrados.length === 0" class="empty-state">
                No hay productos registrados
            </div>
        </div>
    </div>

    <!-- Modal Crear/Editar -->
    <div class="modal-backdrop" *ngIf="modalOpen">
        <div class="modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>{{ editando ? 'Editar' : 'Nuevo' }} Producto</h3>
                <button class="modal-close" (click)="cerrarModal()">&times;</button>
            </div>

            <form (ngSubmit)="guardar()">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Código *</label>
                        <input type="text" class="form-control" [(ngModel)]="productoActual.prodcodigo"
                            name="prodcodigo" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nombre *</label>
                        <input type="text" class="form-control" [(ngModel)]="productoActual.prodnombre"
                            name="prodnombre" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Descripción</label>
                    <textarea class="form-control" [(ngModel)]="productoActual.proddescripcion" name="proddescripcion"
                        rows="2"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Precio Venta $</label>
                        <input type="number" step="0.01" class="form-control"
                            [(ngModel)]="productoActual.prodprecio_venta" name="prodprecio_venta">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stock Mínimo</label>
                        <input type="number" class="form-control" [(ngModel)]="productoActual.prodminimo"
                            name="prodminimo">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Categoría</label>
                        <select class="form-control" [(ngModel)]="productoActual.catid" name="catid">
                            <option [value]="null">-- Seleccionar --</option>
                            <option *ngFor="let c of categorias" [value]="c.catid">{{ c.catnombre }}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">¿Grava IVA?</label>
                        <select class="form-control" [(ngModel)]="productoActual.prodtiene_iva" name="prodtiene_iva">
                            <option [value]="1">Sí (15%)</option>
                            <option [value]="0">No (Exento)</option>
                        </select>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">{{ editando ? 'Guardar Cambios' : 'Crear Producto'
                        }}</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Gestionar Proveedores del Producto -->
    <div class="modal-backdrop" *ngIf="modalProveedoresOpen" (click)="cerrarModalProveedores()">
        <div class="modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>Proveedores de: {{ productoProveedores?.prodnombre }}</h3>
                <button class="modal-close" (click)="cerrarModalProveedores()">&times;</button>
            </div>

            <!-- Proveedores asignados -->
            <div class="proveedores-lista">
                <h4>Proveedores asignados</h4>
                <div *ngIf="proveedoresDelProducto.length === 0" class="empty-mini">
                    Este producto no tiene proveedores asignados
                </div>
                <div *ngFor="let pp of proveedoresDelProducto" class="proveedor-item">
                    <div class="prov-info">
                        <strong>{{ pp.provnombre }}</strong>
                        <small>RUC: {{ pp.provruc }}</small>
                    </div>
                    <button class="btn btn-sm btn-danger" (click)="quitarProveedor(pp.ppid)">Quitar</button>
                </div>
            </div>

            <!-- Asignar nuevo proveedor -->
            <div class="asignar-proveedor" *ngIf="proveedoresDisponibles.length > 0">
                <h4>Agregar proveedor</h4>
                <div class="form-row">
                    <div class="form-group">
                        <select class="form-control" [(ngModel)]="proveedorSeleccionado">
                            <option [ngValue]="null">-- Seleccionar --</option>
                            <option *ngFor="let p of proveedoresDisponibles" [ngValue]="p.provid">
                                {{ p.provnombre }} ({{ p.provruc }})
                            </option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Costo Ref. $</label>
                        <input type="number" step="0.01" class="form-control" [(ngModel)]="costoReferencia">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Días entrega</label>
                        <input type="number" min="1" class="form-control" [(ngModel)]="diasEntrega">
                    </div>
                    <div class="form-group" style="align-self: flex-end">
                        <button class="btn btn-primary" (click)="asignarProveedor()">+ Asignar</button>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" (click)="cerrarModalProveedores()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- ===== MODAL KARDEX ===== -->
    <div class="modal-backdrop" *ngIf="modalKardexOpen" (click)="cerrarKardex()">
        <div class="modal modal-lg" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>Kardex — {{ productoKardex?.prodnombre }}</h3>
                <button class="modal-close" (click)="cerrarKardex()">&times;</button>
            </div>

            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Cantidad</th>
                            <th>Saldo Ant.</th>
                            <th>Saldo Act.</th>
                            <th>Documento</th>
                            <th>Observación</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let k of kardexData">
                            <td>{{ k.karfecha | date:'dd/MM/yyyy HH:mm' }}</td>
                            <td><span class="badge" [ngClass]="getKardexBadge(k.kartipo)">{{ k.kartipo }}</span></td>
                            <td><strong>{{ k.karcantidad }}</strong></td>
                            <td>{{ k.karsaldo_anterior }}</td>
                            <td>{{ k.karsaldo_actual }}</td>
                            <td><small>{{ k.karref_documento || '-' }}</small></td>
                            <td><small>{{ k.karobservacion || '-' }}</small></td>
                        </tr>
                    </tbody>
                </table>

                <div *ngIf="kardexData.length === 0" class="empty-state">
                    No hay movimientos registrados para este producto
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" (click)="cerrarKardex()">Cerrar</button>
            </div>
        </div>
    </div>

</div>