<div class="page-usuarios">
    <header class="page-header">
        <h1>Gesti√≥n de Usuarios</h1>
        <button class="btn btn-primary" (click)="abrirModal()">+ Nuevo Usuario</button>
    </header>

    <!-- Tabla de usuarios -->
    <div class="card">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Usuario</th>
                        <th>Rol</th>
                        <th>Estado</th>
                        <th>Fecha Creaci√≥n</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let u of usuarios">
                        <td>{{ u.usuid }}</td>
                        <td>
                            <strong>{{ u.usuusuario }}</strong>
                        </td>
                        <td>
                            <span class="badge" [ngClass]="getRolClass(u.rolnombre)">
                                {{ u.rolnombre }}
                            </span>
                        </td>
                        <td>
                            <span class="badge" [ngClass]="u.usuactivo ? 'badge-success' : 'badge-danger'">
                                {{ u.usuactivo ? 'Activo' : 'Inactivo' }}
                            </span>
                        </td>
                        <td>{{ u.usucreacion | date:'dd/MM/yyyy HH:mm' }}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-sm btn-secondary" (click)="abrirModal(u)" title="Editar">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button class="btn btn-sm btn-warning" (click)="abrirModalPassword(u)"
                                    title="Cambiar Contrase√±a">
                                    üîë Clave
                                </button>
                                <button class="btn btn-sm btn-danger" (click)="eliminar(u)" title="Eliminar"
                                    *ngIf="u.usuid !== 1">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div *ngIf="usuarios.length === 0 && !loading" class="empty-state">
                No hay usuarios registrados
            </div>
            <div *ngIf="loading" class="empty-state">
                Cargando...
            </div>
        </div>
    </div>

    <!-- Modal Crear/Editar Usuario -->
    <div class="modal-backdrop" *ngIf="modalOpen" (click)="cerrarModal()">
        <div class="modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>{{ editando ? 'Editar' : 'Nuevo' }} Usuario</h3>
                <button class="modal-close" (click)="cerrarModal()">&times;</button>
            </div>

            <form (ngSubmit)="guardar()">
                <div class="form-group">
                    <label class="form-label">Nombre de Usuario *</label>
                    <input type="text" class="form-control" [(ngModel)]="usuarioActual.usuusuario" name="usuusuario"
                        required placeholder="Ej: cajero2">
                </div>

                <div class="form-group" *ngIf="!editando">
                    <label class="form-label">Contrase√±a *</label>
                    <input type="password" class="form-control" [(ngModel)]="usuarioActual.contrasena" name="contrasena"
                        required placeholder="M√≠nimo 5 caracteres">
                </div>

                <div class="form-group">
                    <label class="form-label">Rol *</label>
                    <select class="form-control" [(ngModel)]="usuarioActual.rolid" name="rolid" required>
                        <option [ngValue]="null">-- Seleccionar Rol --</option>
                        <option *ngFor="let r of roles" [ngValue]="r.rolid">{{ r.rolnombre }}</option>
                    </select>
                </div>

                <div class="rol-info" *ngIf="usuarioActual.rolid">
                    <div class="info-box" *ngIf="usuarioActual.rolid == 1">
                        <strong>Administrador:</strong> Acceso total al sistema (Productos, Usuarios, Reportes,
                        Categor√≠as, etc.)
                    </div>
                    <div class="info-box" *ngIf="usuarioActual.rolid == 2">
                        <strong>Cajero:</strong> Acceso a Ventas, Movimientos, Clientes y Productos (consulta)
                    </div>
                    <div class="info-box" *ngIf="usuarioActual.rolid == 3">
                        <strong>Bodeguero:</strong> Acceso a Productos, Movimientos, Categor√≠as y Proveedores
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        {{ editando ? 'Guardar Cambios' : 'Crear Usuario' }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Cambiar Contrase√±a -->
    <div class="modal-backdrop" *ngIf="modalPasswordOpen" (click)="cerrarModalPassword()">
        <div class="modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>üîë Cambiar Contrase√±a</h3>
                <button class="modal-close" (click)="cerrarModalPassword()">&times;</button>
            </div>

            <form (ngSubmit)="cambiarContrasena()">
                <p class="password-info">Cambiando contrase√±a para: <strong>{{ passwordUsuarioNombre }}</strong></p>

                <div class="form-group">
                    <label class="form-label">Contrase√±a Actual *</label>
                    <input type="password" class="form-control" [(ngModel)]="contrasenaActual" name="contrasenaActual"
                        required placeholder="Ingrese la contrase√±a actual">
                </div>

                <div class="form-group">
                    <label class="form-label">Nueva Contrase√±a *</label>
                    <input type="password" class="form-control" [(ngModel)]="nuevaContrasena" name="nuevaContrasena"
                        required placeholder="M√≠nimo 5 caracteres">
                </div>

                <div class="form-group">
                    <label class="form-label">Confirmar Contrase√±a *</label>
                    <input type="password" class="form-control" [(ngModel)]="confirmarContrasena"
                        name="confirmarContrasena" required placeholder="Repita la contrase√±a">
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="cerrarModalPassword()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Cambiar Contrase√±a</button>
                </div>
            </form>
        </div>
    </div>
</div>